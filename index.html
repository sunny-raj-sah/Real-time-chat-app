<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Socket.io</title>
    <link rel="stylesheet" href="style.css">

</head>

<body>
    <ul id="messages"></ul>
    <form id="form">
        <input id="input" autocomplete="off" />
        <button>Send</button>
    </form>
    <div id="typing"></div>
    </div>
    <div style="flex: 1; padding: 10px; border-left: 1px solid gray;">
        <h3>Online Users</h3>
        <ul id="users"></ul>
    </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>

        const socket = io();

        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const messages = document.getElementById("messages");
        const userList = document.getElementById("users");
        const typingDiv = document.getElementById("typing");


        //client-show typing message
        // const typingDiv = document.createElement("div");
        // typingDiv.id = "typing";
        // document.body.appendChild(typingDiv);

        //Ask for username when the user joins
        const username = prompt("Enter your name");

        // // declare state variables properly
        // var tying = false;
        // var timeout;

        // this allow to start the chat with promt name 
        //at very first time
        // while (!username) {
        //     username = prompt("Enter your username:");
        // }

        // Notify server that user joined
        socket.emit("user joined", username);

        //select a user to chat with
        let selectedUser = null;

        userList.addEventListener("click", (e) => {
            if (e.target.tagName === "LI") {
                selectedUser = e.target.textContent;
                alert(`You are now chatting with ${selectedUser}`)
            }

        })

        // declare state variables properly
        let tying = false;
        let timeout;
        function timeoutFunction() {
            typing = false;
            socket.emit("stop typing", username);
        }

        //Detect when user tyes
        input.addEventListener("input", () => {
            // socket.emit("typing", username);
            if (!typing) {
                typing = true;
                socket.emit("typing", username);
            }
            clearTimeout(timeout);
            // after 1s of no typing
            timeout = setTimeout(timeoutFunction, 1000);
        });
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            if (!input.value.trim()) return;

            const msg = { from: username, text: input.value };
            if (selectedUser) {
                //send private message
                socket.emit("private message", { to: selectedUser, ...msg });
            }
            else {
                //broadcast message
                socket.emit("chat message", msg);
            }

            input.value = "";
            // if (input.value) {
            //     socket.emit("chat message", { user: username, text: input.value });
            //     input.value = "";
            // }
        });

        //client receive private message
        socket.on("private message", ({ from, text }) => {
            const item = document.createElement("li");
            item.textContent = `ðŸ”’ ${from} (private): ${text}`;
            item.style.color = "blue";
            messages.appendChild(item);
        })

        //when any on tying this show message
        socket.on("typing", (username) => {
            typingDiv.textContent = `${username} is typing`;

            // Clear after 2 seconds (so it doesnâ€™t stay forever)
            // setTimeout(() => {
            //     typingDiv.textContent = "";
            // }, 2000);
        });
        //stop showing message
        socket.on("stop typing", (username) => {
            typingDiv.textContent = "";
        });

        //client -dispaly system message
        socket.on("system message", function (msg) {
            const item = document.createElement("li");
            item.style.fontStyle = "italic";
            item.style.color = "gray";
            item.textContent = msg;
            messages.appendChild(item);
        });

        // it boardcast the message to all other user 
        socket.on("chat message", function (msg) {
            const item = document.createElement("li");
            item.textContent = `${msg.user}:${msg.text}`;
            messages.appendChild(item);
        });

        //Online users update
        socket.on("online users", (users) => {
            userList.innerHTML = "";
            users.forEach((user) => {
                const li = document.createElement("li");
                li.textContent = user;
                userList.appendChild(li);
            })
        })

    </script>
</body>

</html>